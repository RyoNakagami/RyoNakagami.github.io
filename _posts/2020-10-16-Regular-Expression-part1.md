---
layout: post
title: "正規表現入門 part 1"
subtitle: "正規表現は何か？"
author: "Ryo"
header-img: "img/post-bg-rwd.jpg"
header-mask: 0.4
catelog: true
mathjax: true
purpose: 目的：正規表現の構文の基礎を理解する
goal: 成果物：文字列のキャプチャと置換ができるようになる
tags:

- 正規表現
- チートシート
---

|概要||
|---|---|
|目的|正規表現の構文の基礎を理解する|
|Goal|文字列のキャプチャと置換ができるようになる|
|参考|[Python 3.9 正規表現](https://docs.python.org/ja/3.9/howto/regex.html)<br>[正規表現技術入門 ――最新エンジン実装と理論的背景](https://www.amazon.co.jp/正規表現技術入門-――最新エンジン実装と理論的背景-WEB-PRESS-plus-ebook/dp/B07JHRL2NS/ref=sr_1_5?dchild=1&keywords=正規表現&qid=1602767146&sr=8-5)|
|key word|正規表現, regular expression|

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [1. 正規表現の基本](#1-%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E3%81%AE%E5%9F%BA%E6%9C%AC)
  - [正規表現とは](#%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E3%81%A8%E3%81%AF)
  - [正規表現はどのような時に使うのか？](#%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E3%81%AF%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AA%E6%99%82%E3%81%AB%E4%BD%BF%E3%81%86%E3%81%AE%E3%81%8B)
  - [メタ文字とリテラル](#%E3%83%A1%E3%82%BF%E6%96%87%E5%AD%97%E3%81%A8%E3%83%AA%E3%83%86%E3%83%A9%E3%83%AB)
    - [メタ文字の分類](#%E3%83%A1%E3%82%BF%E6%96%87%E5%AD%97%E3%81%AE%E5%88%86%E9%A1%9E)
    - [量指定子](#%E9%87%8F%E6%8C%87%E5%AE%9A%E5%AD%90)
    - [アンカー（位置指定子）](#%E3%82%A2%E3%83%B3%E3%82%AB%E3%83%BC%E4%BD%8D%E7%BD%AE%E6%8C%87%E5%AE%9A%E5%AD%90)
    - [エスケープシーケンス](#%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9)
  - [その他](#%E3%81%9D%E3%81%AE%E4%BB%96)
- [2. 正規表現の基本演算：連接, 選択, 繰り返し](#2-%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E3%81%AE%E5%9F%BA%E6%9C%AC%E6%BC%94%E7%AE%97%E9%80%A3%E6%8E%A5-%E9%81%B8%E6%8A%9E-%E7%B9%B0%E3%82%8A%E8%BF%94%E3%81%97)
  - [連接](#%E9%80%A3%E6%8E%A5)
  - [選択](#%E9%81%B8%E6%8A%9E)
  - [繰り返し](#%E7%B9%B0%E3%82%8A%E8%BF%94%E3%81%97)
  - [演算子の結合順位](#%E6%BC%94%E7%AE%97%E5%AD%90%E3%81%AE%E7%B5%90%E5%90%88%E9%A0%86%E4%BD%8D)
  - [グループ化](#%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E5%8C%96)
- [3. キャプチャと置換](#3-%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3%E3%81%A8%E7%BD%AE%E6%8F%9B)
  - [文字列の部位とマッチング](#%E6%96%87%E5%AD%97%E5%88%97%E3%81%AE%E9%83%A8%E4%BD%8D%E3%81%A8%E3%83%9E%E3%83%83%E3%83%81%E3%83%B3%E3%82%B0)
  - [キャプチャ](#%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3)
    - [事例 1 順番キャプチャ: bash command`sed` と正規表現を用いてファイルをrenameする](#%E4%BA%8B%E4%BE%8B-1-%E9%A0%86%E7%95%AA%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3-bash-commandsed-%E3%81%A8%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E3%82%92%E7%94%A8%E3%81%84%E3%81%A6%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92rename%E3%81%99%E3%82%8B)
    - [事例 2 名前付きキャプチャ: Pythonと正規表現を用いて日付表現を日本語に直す](#%E4%BA%8B%E4%BE%8B-2-%E5%90%8D%E5%89%8D%E4%BB%98%E3%81%8D%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3-python%E3%81%A8%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE%E3%82%92%E7%94%A8%E3%81%84%E3%81%A6%E6%97%A5%E4%BB%98%E8%A1%A8%E7%8F%BE%E3%82%92%E6%97%A5%E6%9C%AC%E8%AA%9E%E3%81%AB%E7%9B%B4%E3%81%99)
    - [事例 3 順番キャプチャ: 2015年国勢調査shpファイルをcurlコマンドで一括downloadする](#%E4%BA%8B%E4%BE%8B-3-%E9%A0%86%E7%95%AA%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3-2015%E5%B9%B4%E5%9B%BD%E5%8B%A2%E8%AA%BF%E6%9F%BBshp%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92curl%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%A7%E4%B8%80%E6%8B%ACdownload%E3%81%99%E3%82%8B)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## 1. 正規表現の基本
### 正規表現とは

正規表現(regular expression)とは文字列のパターンを記述するための「表現式」です。表現式ということなので数式のように書き方に一定の構文規則(syntax)があります。式は以下の要素の規則的な組み合わせで表現されます：

|要素|説明|
|---|---|
|オペランド|構成要素。例：数式における数|
|オペレーター|演算子。例：数式における`+`や`-`|

一例として、

```
0|1|2|3|4|5|6|7|8|9
```

という正規表現は、0から9までのいずれかの数字1文字という文字列のパターンを表現しています。このパターンは`[0-9]`や`\d`という正規表現でも表現できますが、詳細は後述します。なお「正規」とはある規則に則ってるという意味で理解するとわかりやすいです。

### 正規表現はどのような時に使うのか？

コンピューターのプログラムやデータの多くは文字列で表現されています。そのデータやプログラムを対象に

- 文字列検索
- 文字列の書き換え
- 入力形式のvalidation

といった操作をする時に正規表現は役に立ちます。例えば、とある入力フォームで携帯電話番号を申請者に入力してもらうボックスがあったとします。この時、`080-6666-7777`といった形式で入力してもらいたいが入力情報がそのフォーマットに則っているか確かめたい場合、

```
\d{3}(-\d{4}){2}
```

という正規表現にマッチする文字列しか認めない関数を組むと`aaa-rtyu-gbnu`や`080-99-99`といった入力を拒絶することができます。また、Pythonなどのプログラミング言語の変数名のvalidation処理（例：変数名はアルファベットか_で始まらなくてはならない）も、正規表現で実現されています。そのほかにも多くのテキストエディターで実装されているシンタックスハイライトも、正規表現で特定のプログラミング言語に応じた文字列規則の抽出という処理を実施しています。

### メタ文字とリテラル

正規表現において文字はメタ文字とリテラルの二つの種類に分類されます。


- メタ文字 : metacharacter, 特別な意味を文字のこと
- リテラル : literal, 特別な意味を持たない文字のこと

#### メタ文字の分類

メタ文字は量指定子やアンカーなどの種類に分類されます。

|種類|説明|
|---|---|
|量指定子|繰り返しに関する演算子|
|アンカー（位置指定子）|位置を表す演算子|
|エスケープシーケンス|事前に定義されたオペランド|
|文字クラス|文字のセットを定義する演算子|
|ドット|任意の1文字|

#### 量指定子

|説明|正規表現の例|マッチする例|
|---|---|---|
|`+`|直前の文字が １回以上 繰り返す場合にマッチします。最長一致。条件に合う最長の部分に一致します。|`go+gle`|gogle,go...gle|
|`*`|直前の文字が ０回以上 繰り返す場合にマッチします。最長一致。条件に合う最長の部分に一致します。|`go*gle`|gglego...gle|
|`?`|直前の文字が ０個か１個 の場合にマッチします。最長一致。条件に合う最長の部分に一致します。|`go?gle`|ggle,gogle|
|`+?`|直前の文字が １回以上 繰り返す場合にマッチします。最短一致。条件に合う最短の部分に一致します。|`go+?gle`|gogle,go...gle|
|`*?`|直前の文字が ０回以上 繰り返す場合にマッチします。最短一致。条件に合う最短の部分に一致します。|`go*?xxxgle`|ggle,go...gle|
|`??`|直前の文字が ０個か１個 の場合にマッチします。最短一致。条件に合う最短の部分に一致します。|`go??gle`|ggle, gogle|
|`{n}`|直前の文字の桁数を指定できます。|`a{3}`|aaa|
|`{n,}`|直前の文字の最小桁数のみ指定できます。|`a{3,}`|aaa, aaaa...|
|`{n,m}`|直前の文字の最小桁数と最大桁数を指定できます。最長一致。条件に合う最長の部分に一致します。|`a{3,4}`|aaa, aaaa|
|`{n,m}?`|直前の文字の最小桁数と最大桁数を指定できます。最短一致。条件に合う最短の部分に一致します。|`a{3,4}?`|aaa, aaaa|

#### アンカー（位置指定子）

|文字|説明|正規表現の例|マッチする例|
|---|---|---|---|
|`^`|直後の文字が行の先頭にある場合にマッチします。|`^google`|google...|
|`$`|直前の文字が行の末尾にある場合にマッチします。|`google$`|...google|
|`\<`|単語の先頭にマッチします。|`\<`|*google|
|`\>`|単語の末尾にマッチします。|`\>`|google*|
|`\b`|単語の先頭か末尾にマッチします。|`\b`|*google*|
|`\B`|単語の先頭か末尾以外にマッチします。|`\B`|google|
|`\A`|ファイルの先頭にマッチします。|`\A`|(なし)|
|`\z`|ファイルの末尾にマッチします。|`\z`|(なし)|
|`\G`|直前の一致文字列の末尾にマッチします。|`\G`|(なし)|

#### エスケープシーケンス

|文字|説明|対応する表現|
|---|---|---|
|`\t`|タブ|(なし)|
|`\r`|改行。CR(Carriage Return：0x0D)|(なし)|
|`\n`|改行。LF(Line Feed：0x0A)|(なし)|
|`\d`|すべての数字|`[0-9]`|
|`\D`|すべての数字以外の文字|`[^0-9]`|
|`\s`|垂直タブ以外のすべての空白文字|`[ \t\f\r\n]`|
|`\S`|すべての非空白文字|`[^ \t\f\r\n]`|
|`\w`|アルファベット、アンダーバー、数字|`[a-zA-Z_0-9]`|
|`\W`|アルファベット、アンダーバー、数字以外の文字|`[^a-zA-Z_0-9]`|

### その他

|説明|正規表現の例|マッチする例|
|---|---|---|
|`|`|いずれかの条件 (OR条件) として使われます。|`goog(le|ol)`|google, googol|
|`\`|直後の正規表現記号(メタ文字)を エスケープ します。|`go\+gle`|`go+gle`|
|`.`|任意の１文字 にマッチします。|`.`|Ａ,あ|
|`[...]`|角括弧に含まれるいずれか１文字にマッチします。|`[abc]`, `[a-c]`|a, b, c|
|`[^...]`|角括弧に含まれる文字以外にマッチします。|`[^abc]`, `[^a-c]`|a, b, c以外の文字|
|`(...)`|文字を１つのグループにまとめることができます。|`goog(le|ol)`|google, googol|
|`(...)`|優先させたい演算のグループを指定します|`(ab){2}`|abab|

## 2. 正規表現の基本演算：連接, 選択, 繰り返し

正規表現は

- 連接
- 選択
- 繰り返し

という３つの基本演算を備えています。

### 連接

正規表現を繋げる演算は連接, concatenationと呼ばれます。連接はよく使われる演算なので、演算子として特別な記号はありません。例えばREGEXという文字列はR, E, G,E, Xの5つの文字の連接で成立しています。

### 選択

`r|s`という正規表現はrまたはsというパターンを表しています。

```
[東|京]大
```

は東大と京大の文字列にマッチします。

### 繰り返し

`\d*`は任意の長さの数字列（空文字も含む）を表したり、`[A-Za-z]{1,}`は任意の長さのアルファベット文字列（空文字除く）を表現しています。量指定子を用いることで指定されたパターンの繰り返しから構成される文字列のマッチが可能となります。

### 演算子の結合順位

演算の結合順位とは、どの演算から先に評価するかという順位規則のことです。正規表現における結合順位は

```
繰り返し > 連結 > 選択
```

### グループ化

数式と同じように丸括弧を使って文字列を括ることでどの演算を優先的に評価するかを明示的に指定することができます。丸括弧を用いて正規表現を括る機能をグループ化と呼びます。

`apple|orange*`とすると`apple`または`orange*`にマッチするが、`(apple|orange)*`ならば`appleorange`や`orangeorange`などにマッチします。

## 3. キャプチャと置換

正規表現を用いて文字列のキャプチャと置換を紹介します。文字列に対して正規表現を用いてマッチさせ、マッチした文字列に対して置換という操作をします。

### 文字列の部位とマッチング

文字列には部位を表す三つの用語があります。prefix, suffix, substringです。

|文字列の部位|説明|例|
|---|---|---|
|`prefix`|文字列の先頭部分。n文字から構成される文字列のprefixは空文字も含め$n+1$個存在する。|abは文字列abcdのprefix|
|`suffix`|文字列の後方部分。n文字から構成される文字列のsuffixは空文字も含め$n+1$個存在する。|cdは文字列abcdのsuffix|
|`substring`|文字列に対する部分文字列。n文字から構成される文字列のsubstringは空文字も含め$n\times (n+1)/2 + 1$個存在する。|bcは文字列abcdのsubstring|

この文字列の部位をマッチングのパターンと関連づけると、

|マッチングのパターン|説明|
|---|---|
|前方一致|正規表現が与えられた文字列のprefixにマッチ。アンカー, `^` を用いら部分一致と理解できる。|
|後方一致|正規表現が与えられた文字列のsuffixにマッチ。アンカー, `$` を用いら部分一致と理解できる。|
|部分一致|正規表現が与えられた文字列のsubstringにマッチ。Pythonだとreモジュールの`search()`に対応|
|完全一致|正規表現が与えられた文字列に完全にマッチ。文字列のvalidationに用いられる。Pythonだとreモジュールの`match()`に対応|

### キャプチャ

正規表現と文字列からサブマッチを取得する処理のことをキャプチャと言います。キャプチャには二つの方法があります。

- 順番で指定する方法
- 名前で指定する方法

の二つです。

順番で指定する場合は、正規表現を用いて抽出されたサブマッチのインデックスを利用して、n番目のサブマッチを取得します。名前で指定する方法は、各サブマッチとその名前を辞書の様に対応させ、各サブマッチを取得する方法です。事例を通してこれらを紹介していきます。

#### 事例 1 順番キャプチャ: bash command`sed` と正規表現を用いてファイルをrenameする

`sed` は`grep`と並ぶUnixを代表するコマンドラインツールで、正規表現を使って文字列を置換するときに役に立ちます。`s/regex/replacement/g`という構文で正規表現にマッチした文字列を置換します。一例として、

```
$ echo 'kirakira bushi' | sed -E 's/([A-Za-z]+) ([A-Za-z]+)/\2 \1/'
bushi kirakira
```

`s/regex/replacement/g`のsは置換(substitute)を意味し、末尾のgはglobalを意味しています。globalとはパターンにマッチする文字列全てを置換するオプションです。

前準備が整ったので以下でash command`sed` と正規表現を用いてファイルのrenameを説明します。

まず現在のworking directoryに
```
$ touch a_20190601.tsv a_20190602.tsv a_20190603.tsv a_20190604.tsv a_20190605.tsv a_20190606.tsv
```
で空ファイルを作ります。その結果、

```
a_20190601.tsv
a_20190602.tsv
a_20190603.tsv
a_20190604.tsv
a_20190605.tsv
a_20190606.tsv
```
というファイルができます。`[field1]_[field2].tsv`というファイル名のデータを`[field2]_[field1].tsv`に直したいとします。順番で指定する方法でファイルをrenameします。

```
$ ls -1| sed -nr "s/([a-z]+?)_([0-9]+?)\.tsv/mv & \2_\1.tsv/g" | bash
```

ここでの処理は、

1. `ls -1`でファイル一覧を縦のリストとして取得し、パイプ `|`を用いて`sed`コマンドにファイル一覧を渡します。
2. `sed`の`-r`オプションは以下正規表現を使いますよという命令をします。
3. `sed`の`-n`オプションはマッチしなかったファイルのprint出力をsuppressします
4. `/mv`はmvコマンドを使うという意味です。
5. `\2`と`\1`は`()`でキャプチャしたサブマッチのindexを示しています。なお、 `\0`には、ファイルネームが格納されています。
6. bashコマンドに渡し、Linuxコマンドとして実行することを意味しています。最後の`bash`は結果の保存のためと理解しといてください。

結果、

```
a_20190601.tsv
a_20190602.tsv
a_20190603.tsv
a_20190604.tsv
a_20190605.tsv
a_20190606.tsv
```
となります。


#### 事例 2 名前付きキャプチャ: Pythonと正規表現を用いて日付表現を日本語に直す

次の様な`test.py`ファイルを作成する

```python
import re

def main():
    str1 = "2020-11-31"
    str2  = re.sub('(?P<y>\d{4})-(?P<m>\d{2})-(?P<d>\d{2})',r'\g<y>年\g<m>月\g<d>日',str1)
    print(str2)

if __name__ == "__main__":
    main()
```

これを`python test.py`で実行すると

```
$ python test.py
2020年11月31日
```

と出力される。`(?P<名前>･･･)`と指定すると名前付きキャプチャができるようになる。参照するには`\g<名前>`とします。

#### 事例 3 順番キャプチャ: 2015年国勢調査shpファイルをcurlコマンドで一括downloadする

e-Statでは国勢調査のデータを都道府県別で公開している。2015年の国勢調査のデータのPATHは`https://www.e-stat.go.jp/gis/statmap-search/data?dlserveyId=A002005212015&code=[01-47]&coordSys=1&format=shape&downloadType=5`で`[01-47]`が各都道府県の番号に対応している。このファイルをダウンロードし、その名前は都道府県番号と対応させて保存したいとする。

この時、

```
curl 'https://www.e-stat.go.jp/gis/statmap-search/data?dlserveyId=A002005212015&code=[01-47]&coordSys=1&format=shape&downloadType=5' -o '#1.zip'
```

とすれば`#1`の部分にキャプチャした数値が入力され、このコマンドだけで各都道府県のshpファイルをダウンロードすることができる。

